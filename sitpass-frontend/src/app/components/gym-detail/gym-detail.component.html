<div class="space-y-4" *ngIf="facility; else loadingBlock">
  <section class="overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm">
    <img
      [src]="getFacilityImageUrl()"
      alt="{{ facility.name }}"
      class="h-64 w-full object-cover md:h-80"
    />
    <div class="space-y-3 p-5">
      <div class="flex flex-wrap items-start justify-between gap-3">
        <div>
          <h1 class="text-2xl font-semibold text-slate-900 md:text-3xl">{{ facility.name }}</h1>
          <p class="mt-1 text-sm text-slate-600">{{ facility.description }}</p>
        </div>
        <span class="rounded-full bg-cyan-100 px-3 py-1 text-sm font-medium text-cyan-700">
          Ocena: {{ facility.totalRating }}
        </span>
      </div>

      <div class="grid gap-2 text-sm text-slate-700 md:grid-cols-2">
        <p><strong>Adresa:</strong> {{ facility.address }}</p>
        <p><strong>Grad:</strong> {{ facility.city }}</p>
      </div>

      <div class="flex flex-wrap gap-2 pt-1">
        <button [class]="getSectionButtonClass('disciplines')" (click)="toggleSection('disciplines')">
          Discipline
        </button>
        <button [class]="getSectionButtonClass('workdays')" (click)="toggleSection('workdays')">
          Radno vreme
        </button>
        <button [class]="getSectionButtonClass('reviews')" (click)="toggleSection('reviews')">
          Recenzije
        </button>
        <button
          class="rounded-md border border-indigo-200 bg-indigo-600 px-3 py-2 text-sm font-medium text-white transition hover:bg-indigo-500"
          (click)="openReservationModal()"
        >
          Rezervisi termin
        </button>
        <button
          *ngIf="isAdmin()"
          [routerLink]="['/editFacility', facility.id]"
          class="rounded-md border border-blue-200 bg-blue-600 px-3 py-2 text-sm font-medium text-white transition hover:bg-blue-500"
        >
          Izmeni objekat
        </button>
        <button
          *ngIf="isAdmin()"
          (click)="deleteFacility()"
          class="rounded-md border border-rose-200 bg-rose-600 px-3 py-2 text-sm font-medium text-white transition hover:bg-rose-500"
        >
          Obrisi objekat
        </button>
      </div>
    </div>
  </section>

  <section *ngIf="activeSection === 'disciplines'" class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
    <h2 class="mb-3 text-lg font-semibold text-slate-800">Discipline</h2>
    <ul class="grid gap-2 md:grid-cols-2">
      <li
        *ngFor="let discipline of facility?.disciplines"
        class="rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate-700"
      >
        {{ discipline.name }}
      </li>
    </ul>
  </section>

  <section *ngIf="activeSection === 'workdays'" class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
    <h2 class="mb-3 text-lg font-semibold text-slate-800">Radno vreme</h2>
    <div class="space-y-2">
      <div
        *ngFor="let workDay of facility?.workDays"
        class="flex items-center justify-between rounded-lg border border-slate-200 px-3 py-2 text-sm text-slate-700"
      >
        <span class="font-medium">{{ workDay.day }}</span>
        <span>{{ workDay.startTime }} - {{ workDay.endTime }}</span>
      </div>
    </div>
  </section>

  <section *ngIf="activeSection === 'reviews'" class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
    <div class="mb-3 flex items-center justify-between gap-2">
      <h2 class="text-lg font-semibold text-slate-800">Recenzije</h2>
      <button
        class="rounded-md bg-cyan-600 px-3 py-2 text-sm font-medium text-white transition hover:bg-cyan-500"
        (click)="openModal()"
      >
        Ostavi recenziju
      </button>
    </div>

    <div *ngIf="reviews.length > 0" class="space-y-3">
      <article *ngFor="let review of reviews" class="rounded-xl border border-slate-200 p-3">
        <div class="mb-2 flex items-center justify-between gap-2">
          <div class="flex items-center gap-2">
            <img [src]="getReviewAvatar(review)" alt="Korisnik" class="h-9 w-9 rounded-full" />
            <div>
              <p class="text-sm font-medium text-slate-800">
                {{ review.user?.name }} {{ review.user?.surname }}
              </p>
              <p class="text-xs text-slate-500">{{ review.createdAt | date : "short" }}</p>
            </div>
          </div>
          <span class="rounded-full bg-slate-100 px-2 py-1 text-xs font-medium text-slate-700">
            Prosek: {{ getReviewAverage(review) }}
          </span>
        </div>

        <div class="grid gap-2 text-xs text-slate-600 md:grid-cols-4">
          <p><strong>Oprema:</strong> {{ review.rates?.equipment }}</p>
          <p><strong>Osoblje:</strong> {{ review.rates?.staff }}</p>
          <p><strong>Higijena:</strong> {{ review.rates?.hygiene }}</p>
          <p><strong>Prostor:</strong> {{ review.rates?.space }}</p>
        </div>
      </article>
    </div>

    <div
      *ngIf="reviews.length === 0"
      class="rounded-xl border border-dashed border-slate-300 bg-slate-50 p-4 text-center text-sm text-slate-600"
    >
      <img
        src="https://images.pexels.com/photos/1229356/pexels-photo-1229356.jpeg?auto=compress&cs=tinysrgb&w=900&h=260&dpr=1"
        alt="No reviews"
        class="mb-2 h-24 w-full rounded-lg object-cover"
      />
      Trenutno nema recenzija za ovaj objekat.
    </div>
  </section>
</div>

<ng-template #loadingBlock>
  <div class="rounded-xl border border-slate-200 bg-white p-6 text-sm text-slate-600 shadow-sm">
    Ucitavanje detalja objekta...
  </div>
</ng-template>

<div *ngIf="showReservationModal" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/60 p-4">
  <div class="w-full max-w-md rounded-xl border border-slate-200 bg-white p-5 shadow-xl">
    <h3 class="mb-3 text-lg font-semibold text-slate-800">Rezervacija termina</h3>
    <div class="space-y-3">
      <label class="flex flex-col gap-1 text-sm text-slate-700">
        Pocetak
        <input type="datetime-local" [(ngModel)]="reservationStart" class="rounded-lg border border-slate-300 p-2" />
      </label>
      <label class="flex flex-col gap-1 text-sm text-slate-700">
        Kraj
        <input type="datetime-local" [(ngModel)]="reservationEnd" class="rounded-lg border border-slate-300 p-2" />
      </label>
    </div>
    <div class="mt-4 flex justify-end gap-2">
      <button (click)="closeReservationModal()" class="rounded-md bg-slate-200 px-3 py-2 text-sm text-slate-700 hover:bg-slate-300">
        Odustani
      </button>
      <button (click)="submitReservation()" class="rounded-md bg-indigo-600 px-3 py-2 text-sm font-medium text-white hover:bg-indigo-500">
        Potvrdi
      </button>
    </div>
  </div>
</div>

<div *ngIf="showModal" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/60 p-4">
  <div class="w-full max-w-lg rounded-xl border border-slate-200 bg-white p-5 shadow-xl">
    <h3 class="mb-3 text-lg font-semibold text-slate-800">Nova recenzija</h3>

    <div class="grid gap-3 md:grid-cols-2">
      <label class="flex flex-col gap-1 text-sm text-slate-700">
        Oprema (0-10)
        <input type="number" [(ngModel)]="newRate.equipment" min="0" max="10" class="rounded-lg border border-slate-300 p-2" />
      </label>
      <label class="flex flex-col gap-1 text-sm text-slate-700">
        Osoblje (0-10)
        <input type="number" [(ngModel)]="newRate.staff" min="0" max="10" class="rounded-lg border border-slate-300 p-2" />
      </label>
      <label class="flex flex-col gap-1 text-sm text-slate-700">
        Higijena (0-10)
        <input type="number" [(ngModel)]="newRate.hygiene" min="0" max="10" class="rounded-lg border border-slate-300 p-2" />
      </label>
      <label class="flex flex-col gap-1 text-sm text-slate-700">
        Prostor (0-10)
        <input type="number" [(ngModel)]="newRate.space" min="0" max="10" class="rounded-lg border border-slate-300 p-2" />
      </label>
    </div>

    <label class="mt-3 flex flex-col gap-1 text-sm text-slate-700">
      Komentar
      <textarea [(ngModel)]="commentText" rows="3" class="rounded-lg border border-slate-300 p-2"></textarea>
    </label>

    <div class="mt-4 flex justify-end gap-2">
      <button (click)="closeModal()" class="rounded-md bg-slate-200 px-3 py-2 text-sm text-slate-700 hover:bg-slate-300">
        Odustani
      </button>
      <button (click)="submitReview()" class="rounded-md bg-cyan-600 px-3 py-2 text-sm font-medium text-white hover:bg-cyan-500">
        Objavi recenziju
      </button>
    </div>
  </div>
</div>
